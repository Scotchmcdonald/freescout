class e{constructor(){var e,t;this.userId=null==(e=document.querySelector('meta[name="user-id"]'))?void 0:e.content,this.conversationId=null==(t=document.querySelector('meta[name="conversation-id"]'))?void 0:t.content,this.notificationContainer=null,this.setupContainer()}setupContainer(){if(document.querySelector("#notification-container"))this.notificationContainer=document.querySelector("#notification-container");else{const e=document.createElement("div");e.id="notification-container",e.className="fixed top-4 right-4 z-50 space-y-2",document.body.appendChild(e),this.notificationContainer=e}}init(){this.userId&&window.Echo&&(this.subscribeToUserChannel(),this.conversationId&&this.subscribeToConversationChannel())}subscribeToUserChannel(){window.Echo.private(`user.${this.userId}`).listen(".message.new",e=>{this.handleNewMessage(e)}).listen(".conversation.updated",e=>{this.handleConversationUpdate(e)}).notification(e=>{this.showNotification(e)})}subscribeToConversationChannel(){window.Echo.join(`conversation.${this.conversationId}`).here(e=>{this.updateViewers(e)}).joining(e=>{this.addViewer(e)}).leaving(e=>{this.removeViewer(e)}).listen(".user.viewing",e=>{this.handleUserViewing(e)})}handleNewMessage(e){this.conversationId&&this.conversationId==e.conversation_id||(this.showBrowserNotification(`New message in #${e.conversation_number}`,e.preview,`/conversations/${e.conversation_id}`),this.showInAppNotification({title:`New message in #${e.conversation_number}`,message:e.preview,from:e.customer_name||e.user_name,url:`/conversations/${e.conversation_id}`,type:"message"}),this.updateConversationList(e.conversation_id))}handleConversationUpdate(e){this.updateConversationList(e.id),this.conversationId&&this.conversationId==e.id&&this.updateConversationView(e)}handleUserViewing(e){if(e.user_id==this.userId)return;const t=e.is_replying?`${e.user_name} is replying...`:`${e.user_name} is viewing`;this.showUserActivity(e.user_id,e.user_name,t)}showInAppNotification({title:e,message:t,from:n,url:i,type:s="info"}){const o=document.createElement("div");o.className="\n            bg-white border-l-4 border-blue-500 rounded-lg shadow-lg p-4 \n            transform transition-all duration-300 ease-in-out\n            hover:shadow-xl cursor-pointer max-w-sm\n        ",o.innerHTML=`\n            <div class="flex items-start">\n                <div class="flex-shrink-0">\n                    <svg class="h-6 w-6 text-blue-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" \n                              d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />\n                    </svg>\n                </div>\n                <div class="ml-3 flex-1">\n                    <p class="text-sm font-medium text-gray-900">${this.escapeHtml(e)}</p>\n                    ${n?`<p class="mt-1 text-xs text-gray-500">${this.escapeHtml(n)}</p>`:""}\n                    ${t?`<p class="mt-1 text-sm text-gray-600">${this.escapeHtml(t)}</p>`:""}\n                </div>\n                <button class="ml-4 flex-shrink-0 text-gray-400 hover:text-gray-500" onclick="this.parentElement.parentElement.remove()">\n                    <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />\n                    </svg>\n                </button>\n            </div>\n        `,i&&o.addEventListener("click",e=>{e.target.closest("button")||(window.location.href=i)}),this.notificationContainer.appendChild(o),setTimeout(()=>{o.style.opacity="0",setTimeout(()=>o.remove(),300)},5e3)}showBrowserNotification(e,t,n){if("Notification"in window&&"granted"===Notification.permission){const i=new Notification(e,{body:t,icon:"/favicon.png",tag:n});i.onclick=()=>{window.focus(),n&&(window.location.href=n),i.close()}}}requestNotificationPermission(){"Notification"in window&&"default"===Notification.permission&&Notification.requestPermission()}showUserActivity(e,t,n){const i=document.querySelector("#conv-viewers");if(!i)return;let s=i.querySelector(`.viewer-${e}`);s||(s=document.createElement("div"),s.className=`viewer-${e} flex items-center space-x-2 text-sm text-gray-600 p-2 bg-blue-50 rounded`,i.appendChild(s)),s.innerHTML=`\n            <div class="flex-shrink-0">\n                <div class="h-8 w-8 rounded-full bg-blue-500 flex items-center justify-center text-white text-xs">\n                    ${t.charAt(0).toUpperCase()}\n                </div>\n            </div>\n            <span>${this.escapeHtml(n)}</span>\n        `,setTimeout(()=>s.remove(),3e4)}updateViewers(e){const t=document.querySelector("#conv-viewers");t&&(t.innerHTML="",e.forEach(e=>{e.id!=this.userId&&this.showUserActivity(e.id,e.name,`${e.name} is viewing`)}))}addViewer(e){e.id!=this.userId&&this.showUserActivity(e.id,e.name,`${e.name} joined`)}removeViewer(e){const t=document.querySelector(`.viewer-${e.id}`);t&&t.remove()}updateConversationList(e){const t=document.querySelector(`[data-conversation-id="${e}"]`);t&&fetch(`/conversations/${e}/preview`).then(e=>e.text()).then(e=>{t.outerHTML=e}).catch(e=>{})}updateConversationView(e){const t=document.querySelector("#conversation-status");if(t&&e.status&&(t.textContent=this.getStatusLabel(e.status),t.className=this.getStatusClass(e.status)),e.user_id){const t=document.querySelector("#conversation-assignee");t&&fetch(`/users/${e.user_id}/name`).then(e=>e.text()).then(e=>t.textContent=e).catch(e=>{})}}getStatusLabel(e){return{1:"Active",2:"Pending",3:"Closed",4:"Spam"}[e]||"Unknown"}getStatusClass(e){return{1:"px-2 py-1 text-xs font-semibold rounded bg-green-100 text-green-800",2:"px-2 py-1 text-xs font-semibold rounded bg-yellow-100 text-yellow-800",3:"px-2 py-1 text-xs font-semibold rounded bg-gray-100 text-gray-800",4:"px-2 py-1 text-xs font-semibold rounded bg-red-100 text-red-800"}[e]||"px-2 py-1 text-xs font-semibold rounded bg-gray-100 text-gray-800"}escapeHtml(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}}if("loading"===document.readyState)document.addEventListener("DOMContentLoaded",()=>{const t=new e;t.init(),t.requestNotificationPermission()});else{const t=new e;t.init(),t.requestNotificationPermission()}export{e as RealtimeNotifications};
