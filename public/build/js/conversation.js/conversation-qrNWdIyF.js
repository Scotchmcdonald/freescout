import{UIHelpers as t}from"../ui-helpers.js/ui-helpers-BYVGA8V-.js";import{RichTextEditor as e}from"../editor.js/editor-B9-_YOU6.js";import"../chunk/vendor-ui-CosFLO3C.js";import"../chunk/vendor-editor-L7A9Ap2O.js";class o{constructor(){var t;this.conversationId=null==(t=document.querySelector('meta[name="conversation-id"]'))?void 0:t.content,this.editor=null,this.autoSaveTimer=null,this.autoSaveInterval=12e3,this.init()}init(){this.conversationId&&(this.initEditor(),this.initReplyForm(),this.initAutoSave(),this.initConversationActions(),this.loadDraft(),this.initCollisionDetection())}initEditor(){const t=document.querySelector("#reply-body");t&&(this.editor=new e(t,{placeholder:"Type your reply...",minHeight:"200px",onUpdate:t=>{this.onEditorChange(t)},onSaveDraft:()=>this.saveDraft(!0),onDiscard:()=>this.discardDraft(),onAttachment:()=>this.showAttachmentDialog()}))}initReplyForm(){const t=document.querySelector("#conversation-reply-form");t&&t.addEventListener("submit",async t=>{t.preventDefault(),await this.submitReply()}),document.querySelectorAll('[name="reply_type"]').forEach(t=>{t.addEventListener("change",t=>{this.switchReplyType(t.target.value)})})}initAutoSave(){let t=!1;this.editor&&this.editor.editor.on("update",()=>{t=!0}),this.autoSaveTimer=setInterval(()=>{t&&(this.saveDraft(!1),t=!1)},this.autoSaveInterval)}initConversationActions(){var t,e;document.querySelectorAll('[data-action="change-status"]').forEach(t=>{t.addEventListener("click",async e=>{e.preventDefault();const o=t.dataset.status;await this.changeStatus(o)})}),document.querySelectorAll('[data-action="assign-user"]').forEach(t=>{t.addEventListener("click",async e=>{e.preventDefault();const o=t.dataset.userId;await this.assignUser(o)})}),null==(t=document.querySelector('[data-action="toggle-follow"]'))||t.addEventListener("click",async t=>{t.preventDefault(),await this.toggleFollow()}),null==(e=document.querySelector('[data-action="toggle-star"]'))||e.addEventListener("click",async t=>{t.preventDefault(),await this.toggleStar()})}onEditorChange(t){window.fsReplyChanged=!0;const e=document.querySelector("#autosave-indicator");e&&(e.textContent="")}async saveDraft(e=!1){var o;const n=null==(o=this.editor)?void 0:o.getHTML();if(n&&"<p></p>"!==n)try{if((await fetch(`/conversations/${this.conversationId}/draft`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({content:n})})).ok){const o=document.querySelector("#autosave-indicator");o&&(o.textContent="Draft saved at "+(new Date).toLocaleTimeString(),o.className="text-sm text-green-600"),e&&t.showToast("Draft saved","success")}}catch(s){e&&t.showToast("Failed to save draft","error")}}async loadDraft(){try{const t=await fetch(`/conversations/${this.conversationId}/draft`);if(t.ok){const e=await t.json();e.content&&this.editor&&this.editor.setContent(e.content)}}catch(t){}}async discardDraft(){var e;if(await t.confirm("Discard Draft","Are you sure you want to discard this draft?","Discard","Cancel")){null==(e=this.editor)||e.setContent("");try{await fetch(`/conversations/${this.conversationId}/draft`,{method:"DELETE",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content}}),t.showToast("Draft discarded","success")}catch(o){}}}async submitReply(){var e,o;const n=document.querySelector("#conversation-reply-form"),s=null==(e=this.editor)?void 0:e.getHTML();if(s&&"<p></p>"!==s){t.showLoading("Sending...");try{const e=new FormData(n);e.set("body",s);const a=await fetch(n.action,{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:e});if(t.hideLoading(),a.ok){await a.json();t.showToast("Reply sent successfully","success"),null==(o=this.editor)||o.setContent(""),window.location.reload()}else{const e=await a.json();t.showToast(e.message||"Failed to send reply","error")}}catch(a){t.hideLoading(),t.showToast("Failed to send reply","error")}}else t.showToast("Please enter a message","warning")}switchReplyType(t){const e=document.querySelector("#conversation-reply-form");if(e){e.dataset.replyType=t;const o=document.querySelector("#note-indicator");o&&o.classList.toggle("hidden","note"!==t)}}async changeStatus(e){try{if((await fetch(`/conversations/${this.conversationId}/status`,{method:"PATCH",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({status:e})})).ok){t.showToast("Status updated","success");const o=document.querySelector("#conversation-status");o&&(o.textContent=this.getStatusLabel(e),o.className=this.getStatusClass(e))}}catch(o){t.showToast("Failed to update status","error")}}async assignUser(e){try{(await fetch(`/conversations/${this.conversationId}/assign`,{method:"PATCH",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({user_id:e})})).ok&&(t.showToast("Assignee updated","success"),window.location.reload())}catch(o){t.showToast("Failed to update assignee","error")}}async toggleFollow(){try{const e=await fetch(`/conversations/${this.conversationId}/follow`,{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content}});if(e.ok){const o=await e.json();t.showToast(o.following?"Following conversation":"Unfollowed conversation","success");const n=document.querySelector('[data-action="toggle-follow"]');n&&(n.textContent=o.following?"Unfollow":"Follow")}}catch(e){}}async toggleStar(){try{const t=await fetch(`/conversations/${this.conversationId}/star`,{method:"POST",headers:{"X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content}});if(t.ok){const e=await t.json(),o=document.querySelector('[data-action="toggle-star"] svg');o&&o.classList.toggle("fill-yellow-400",e.starred)}}catch(t){}}initCollisionDetection(){window.Echo&&window.Echo.join(`conversation.${this.conversationId}`).listen(".user.viewing",t=>{var e;if(t.user_id!==(null==(e=document.querySelector('meta[name="user-id"]'))?void 0:e.content)){const e=t.is_replying?`${t.user_name} is replying...`:`${t.user_name} is viewing this conversation`;this.showCollisionWarning(e)}}),setInterval(()=>{var t,e;const o=(null==(e=null==(t=document.querySelector("#reply-body"))?void 0:t.value)?void 0:e.length)>0;(window.fsReplyChanged||o)&&this.broadcastPresence(o)},5e3)}showCollisionWarning(t){let e=document.querySelector("#collision-warning");e||(e=document.createElement("div"),e.id="collision-warning",e.className="fixed top-20 right-4 bg-yellow-100 border-l-4 border-yellow-500 p-4 rounded shadow-lg z-50",document.body.appendChild(e)),e.textContent=t,setTimeout(()=>e.remove(),1e4)}async broadcastPresence(t){try{await fetch(`/conversations/${this.conversationId}/presence`,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({is_replying:t})})}catch(e){}}showAttachmentDialog(){const t=document.querySelector("#attachment-input");t&&t.click()}getStatusLabel(t){return{1:"Active",2:"Pending",3:"Closed",4:"Spam"}[t]||"Unknown"}getStatusClass(t){const e={1:"px-2 py-1 text-xs font-semibold rounded bg-green-100 text-green-800",2:"px-2 py-1 text-xs font-semibold rounded bg-yellow-100 text-yellow-800",3:"px-2 py-1 text-xs font-semibold rounded bg-gray-100 text-gray-800",4:"px-2 py-1 text-xs font-semibold rounded bg-red-100 text-red-800"};return e[t]||e[1]}destroy(){this.autoSaveTimer&&clearInterval(this.autoSaveTimer),this.editor&&this.editor.destroy()}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",()=>{new o}):new o;export{o as ConversationManager,o as default};
